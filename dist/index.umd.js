!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("util"),require("amqplib"),require("envalid")):"function"==typeof define&&define.amd?define(["util","amqplib","envalid"],e):(t||self).knackMq=e(t.util,t.amqplib,t.envalid)}(this,function(t,e,n){function o(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var r=/*#__PURE__*/o(t),i=/*#__PURE__*/o(e);function s(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,c(t,e)}function c(t,e){return c=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},c(t,e)}require("dotenv").config();var u,a=/*#__PURE__*/function(){function t(t){var e=this;this.user=void 0,this.password=void 0,this.host=void 0,this.port=void 0,this.vhost=void 0,this.url=void 0,this.channel=void 0,this.canUseEnvConfig(t)?n.cleanEnv(process.env,{RABBITMQ_HOST:n.str(),RABBITMQ_PASSWORD:n.str(),RABBITMQ_PORT:n.port({default:5672}),RABBITMQ_USER:n.str(),RABBITMQ_VHOST:n.str()}):(this.user=t.user,this.password=t.password,this.host=t.host,this.port=t.port,this.vhost=t.vhost),this.url=r.default.format("amqp://%s:%s@%s:%s/%s",this.user||process.env.RABBITMQ_USER,this.password||process.env.RABBITMQ_PASSWORD,this.host||process.env.RABBITMQ_HOST,this.port||process.env.RABBITMQ_PORT,this.vhost||process.env.RABBITMQ_VHOST),this.connect(this.url).then(function(t){e.channel=t})}var e=t.prototype;return e.getChannel=function(){return this.channel},e.canUseEnvConfig=function(t){return void 0!==t.useEnvironmentConfig},e.connect=function(t){try{return Promise.resolve(i.default.connect(t)).then(function(t){return Promise.resolve(t.createChannel())})}catch(t){return Promise.reject(t)}},e.send=function(t){try{var e=this;try{if(e.channel){console.log("[Data]",t),e.channel.assertQueue(t.queue,{durable:!0});var n=e.channel.sendToQueue(t.queue,Buffer.from(JSON.stringify(t.data)));console.log("[MQ Status]",n),console.log(" [x] Sent %s",t.data)}}catch(t){console.log(t)}return Promise.resolve()}catch(t){return Promise.reject(t)}},e.onReceive=function(t){try{var e=this;return e.connect(e.url).then(function(){setTimeout(function(){e.listen(t)},500)}),Promise.resolve()}catch(t){return Promise.reject(t)}},e.listen=function(t){var e=this,n=t.queue,o=t.callback;try{this.channel.assertQueue(n),this.channel.consume(n,function(t){console.log("[x] receiving messages"),e.channel.ack(t),o(t)})}catch(t){console.log(t)}},t}(),h=/*#__PURE__*/function(t){function e(){return t.apply(this,arguments)||this}return s(e,t),e.prototype.sendEmail=function(t){var e=t.queue;this.send({data:t.data,queue:void 0===e?"email_notification":e})},e}(a),f=/*#__PURE__*/function(t){function e(){return t.apply(this,arguments)||this}return s(e,t),e.prototype.createNotification=function(t){var e=t.queue;this.send({data:t.data,queue:void 0===e?"event_notification":e})},e}(a),l=/*#__PURE__*/function(t){function e(){return t.apply(this,arguments)||this}return s(e,t),e}(a);return u=l,[h,f].forEach(function(t){Object.getOwnPropertyNames(t.prototype).forEach(function(e){Object.defineProperty(u.prototype,e,Object.getOwnPropertyDescriptor(t.prototype,e))})}),l});
